name: Playwright UI

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  ui-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci

      - run: npx playwright install --with-deps

      - name: Run UI tests
        run: npx playwright test --project=chromium-ui

      - name: Generate Allure report
        if: always()
        run: |
          if [ -d "allure-results" ]; then
            npx allure-commandline generate allure-results --clean -o allure-report
          else
            echo "No allure-results found, skipping report generation."
          fi

      - name: Prepare Telegram config
        if: always() && hashFiles('allure-report/**') != ''
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT: ${{ secrets.TG_CHAT }}
          REPORT_LINK: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/ui
          BUILD_NUMBER: ${{ github.run_number }}
          BUILD_TIMESTAMP: ${{ github.event.head_commit.timestamp }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          if [ -z "$TG_TOKEN" ] || [ -z "$TG_CHAT" ]; then
            echo "Telegram secrets are not set. Skipping config generation."
            exit 0
          fi
          python - <<'PY'
          import json, os
          from datetime import datetime

          src = "notifications/config.json"
          dst = "notifications/config.ci.json"
          with open(src, encoding="utf-8") as f:
              data = json.load(f)

          # Parse and format timestamp
          timestamp = os.environ.get("BUILD_TIMESTAMP", "")
          if timestamp:
              dt = datetime.fromisoformat(timestamp.replace("Z", "+00:00"))
              formatted_timestamp = dt.strftime("%d.%m.%Y %H:%M:%S")
          else:
              formatted_timestamp = datetime.now().strftime("%d.%m.%Y %H:%M:%S")

          data["telegram"]["token"] = os.environ["TG_TOKEN"]
          data["telegram"]["chat"] = os.environ["TG_CHAT"]
          data["base"]["reportLink"] = os.environ.get("REPORT_LINK", "")

          # Add custom info to comment
          build_number = os.environ.get('BUILD_NUMBER', 'N/A')
          actor = os.environ.get('GITHUB_ACTOR', 'Unknown')
          data["base"]["comment"] = f"UI tests | Browser: Chromium | Run: #{build_number} | Started by: {actor} | {formatted_timestamp}"

          with open(dst, "w", encoding="utf-8") as f:
              json.dump(data, f, ensure_ascii=False, indent=2)
          PY

      - name: Send Telegram notification
        if: always() && hashFiles('allure-report/**') != ''
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT: ${{ secrets.TG_CHAT }}
          REPORT_LINK: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/ui
        run: |
          if [ -z "$TG_TOKEN" ] || [ -z "$TG_CHAT" ]; then
            echo "Telegram secrets are not set. Skipping notification."
            exit 0
          fi
          java -DconfigFile=notifications/config.ci.json -jar notifications/allure-notifications-4.8.0.jar

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
          if-no-files-found: ignore

      - name: Publish Allure report to GitHub Pages
        if: always() && hashFiles('allure-report/**') != ''
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-report
          destination_dir: ui

  api-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci

      - run: npx playwright install --with-deps

      - name: Run API tests
        run: npx playwright test --project=api

      - name: Generate Allure report
        if: always()
        run: |
          if [ -d "allure-results" ]; then
            npx allure-commandline generate allure-results --clean -o allure-report
          else
            echo "No allure-results found, skipping report generation."
          fi

      - name: Prepare Telegram config
        if: always() && hashFiles('allure-report/**') != ''
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT: ${{ secrets.TG_CHAT }}
          REPORT_LINK: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/api
          BUILD_NUMBER: ${{ github.run_number }}
          BUILD_TIMESTAMP: ${{ github.event.head_commit.timestamp }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          if [ -z "$TG_TOKEN" ] || [ -z "$TG_CHAT" ]; then
            echo "Telegram secrets are not set. Skipping config generation."
            exit 0
          fi
          python - <<'PY'
          import json, os
          from datetime import datetime

          src = "notifications/config.api.json"
          dst = "notifications/config.api.ci.json"
          with open(src, encoding="utf-8") as f:
              data = json.load(f)

          # Parse and format timestamp
          timestamp = os.environ.get("BUILD_TIMESTAMP", "")
          if timestamp:
              dt = datetime.fromisoformat(timestamp.replace("Z", "+00:00"))
              formatted_timestamp = dt.strftime("%d.%m.%Y %H:%M:%S")
          else:
              formatted_timestamp = datetime.now().strftime("%d.%m.%Y %H:%M:%S")

          data["telegram"]["token"] = os.environ["TG_TOKEN"]
          data["telegram"]["chat"] = os.environ["TG_CHAT"]
          data["base"]["reportLink"] = os.environ.get("REPORT_LINK", "")

          # Add custom info to comment
          build_number = os.environ.get('BUILD_NUMBER', 'N/A')
          actor = os.environ.get('GITHUB_ACTOR', 'Unknown')
          data["base"]["comment"] = f"API tests | Run: #{build_number} | Started by: {actor} | {formatted_timestamp}"

          with open(dst, "w", encoding="utf-8") as f:
              json.dump(data, f, ensure_ascii=False, indent=2)
          PY

      - name: Send Telegram notification
        if: always() && hashFiles('allure-report/**') != ''
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT: ${{ secrets.TG_CHAT }}
          REPORT_LINK: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/api
        run: |
          if [ -z "$TG_TOKEN" ] || [ -z "$TG_CHAT" ]; then
            echo "Telegram secrets are not set. Skipping notification."
            exit 0
          fi
          java -DconfigFile=notifications/config.api.ci.json -jar notifications/allure-notifications-4.8.0.jar

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-api
          path: playwright-report
          if-no-files-found: ignore

      - name: Publish Allure report to GitHub Pages
        if: always() && hashFiles('allure-report/**') != ''
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-report
          destination_dir: api
